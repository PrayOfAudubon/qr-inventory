<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¶ã‚¤å­ã¡ã‚ƒã‚“(â‹ˆâ—ï¼â—¡ï¼œâ—)ã€‚âœ§â™¡</title>

  <style>
/* ========== å…±é€šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ========== */
body{
  font-family:'Segoe UI','Helvetica Neue',sans-serif;
  background:#f4f6fa;margin:0;padding:0;font-size:22px;
}
header{
  background:linear-gradient(90deg,#42a5f5,#1e88e5);
  color:#fff;text-align:center;padding:28px 20px;
  box-shadow:0 2px 6px rgba(0,0,0,.2);
}
header h2{font-size:28px;line-height:1.8;margin:0;text-shadow:1px 1px 3px rgba(0,0,0,.2);}
main{width:100vw;padding:24px;box-sizing:border-box;}

#reader{
  margin:20px 0;padding:24px;background:#fff;border-radius:16px;
  box-shadow:0 2px 8px rgba(0,0,0,.08);width:100%;
}
#formArea{
  padding:32px 24px;background:#fff;
  border:1px solid #e0e0e0;border-radius:20px;
  box-shadow:0 8px 24px rgba(0,0,0,.06);margin-top:24px;
}

/* ========== "ãƒ©ãƒ™ãƒ«:å€¤" ã‚’ 2 åˆ—ã‚°ãƒªãƒƒãƒ‰ã§ ========== */
.field{
  display:grid;grid-template-columns:max-content 1fr;align-items:center;
  column-gap:12px;background:#fff;border:1px solid #e0e0e0;border-radius:12px;
  padding:14px 18px;margin:16px 0;
}
.label{
  font-weight:700;font-size:22px;white-space:nowrap;margin:0;
}
.value{
  font-weight:600;font-size:22px;color:#1565c0;margin:0;word-break:break-all;
}

/* ========== åœ¨åº«ã‚¼ãƒ­ã§ç‚¹æ»… ========== */
#stockDisplay.zero{color:#e91e63;animation:blink 1s steps(2,start) infinite;}
@keyframes blink{to{visibility:hidden;}}

/* ========== ã‚»ãƒ¬ã‚¯ãƒˆãƒ»ãƒœã‚¿ãƒ³ ========== */
select{
  width:100%;padding:18px;font-size:22px;border-radius:14px;
  border:1px solid #ccc;margin:22px 0 0;box-shadow:inset 0 1px 2px rgba(0,0,0,.04);
}
.btn{
  display:block;width:100%;padding:18px;margin:14px 0;font-size:22px;
  color:#fff;border:none;border-radius:32px;cursor:pointer;
  background:linear-gradient(90deg,#42a5f5,#1e88e5);
  box-shadow:0 4px 6px rgba(0,0,0,.1);transition:transform .1s ease;
}
.btn:hover{transform:translateY(-2px);background:linear-gradient(90deg,#1e88e5,#1565c0);}

/* ç”¨é€”ãƒœã‚¿ãƒ³å¼·èª¿ */
.mode-btn      {background:#1e88e5;}
.mode-btn:hover{background:#1565c0;}
.mode-btn.active{
  background:#ef5350;box-shadow:0 0 0 3px #ffcdd2 inset;
}
/* é»’ã„ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ ã‚’æ¶ˆã™ */
.mode-btn:focus{outline:none;}

/* ========== ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— ========== */
.popup-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.4);
  display:none;justify-content:center;align-items:center;z-index:1000;
}
.popup{
  background:#fff;border-radius:20px;padding:28px;width:90%;max-width:420px;
  box-shadow:0 4px 16px rgba(0,0,0,.2);text-align:center;
}
.popup-header{font-size:26px;font-weight:bold;margin-bottom:14px;}
.popup-content{font-size:22px;margin-bottom:24px;}
.popup-button,.popup-close{
  background:#42a5f5;border:none;color:#fff;padding:16px 28px;font-size:22px;
  border-radius:32px;cursor:pointer;margin:8px 0;
}
.popup-button:hover{background:#1e88e5;}
.popup-close{
  position:absolute;top:10px;right:14px;background:none;color:#999;font-size:26px;
}
.popup-close:hover{color:#666;}

.hidden{display:none!important;}

  </style>
</head>
<body>
  <header>
    <h2>åœ¨åº«ç®¡ç†ã®ãƒ¤ãƒ‹ã™ã‘ã ã‚ˆğŸš¬<br>QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚“ã§ã­â™¡</h2>
  </header>

  <main>
  <!-- â‘  QR ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é ˜åŸŸ -->
  <video id="reader" playsinline muted></video>
  <div id="result" style="margin-top:8px;color:#089;">èª­ã¿å–ã‚Šå¾…æ©Ÿä¸­â€¦</div>

  <!-- â‘¡ ã‚«ãƒ¡ãƒ©é–‹å§‹ãƒœã‚¿ãƒ³ & ç”»åƒãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ -->
  <button id="startCameraBtn" class="btn">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•</button>
  <input id="fileInput"
         type="file"
         accept="image/*"
         capture="environment"
         class="hidden">

    <div id="formArea" class="hidden">
      <div class="field">
        <span class="label">èª­ã¿å–ã£ãŸå“ç›®ã‚³ãƒ¼ãƒ‰ï¼š</span>
        <span id="codeDisplay" class="value"></span>
      </div>

      <!-- ç”¨é€”é¸æŠ -->
      <p class="label">ç”¨é€”é¸æŠ</p>
      <div id="modeSelect">
        <button class="btn mode-btn" onclick="setMode('å¤–æ¥', this)">å¤–æ¥ç”¨</button>
        <button class="btn mode-btn" onclick="setMode('è¨ªå•', this)">è¨ªå•ç”¨</button>
      </div>

      <div class="field">
        <span class="label">å“ç›®åï¼š</span>
        <span id="itemNameDisplay" class="value"></span>
      </div>

      <div class="field">
        <span class="label">åœ¨åº«æ•°ï¼š</span>
        <span id="stockDisplay" class="value"></span>
      </div>

      <p class="label">ã‚¹ã‚¿ãƒƒãƒ•å</p>
      <select id="staffSelect">
        <option value="">--é¸æŠã—ã¦ãã ã•ã„--</option>
        <option value="æ¸¡ä¼š">æ¸¡ä¼š</option><option value="å±±å´">å±±å´</option>
        <option value="ä¸­é‡">ä¸­é‡</option><option value="æ¡¶å·">æ¡¶å·</option>
        <option value="åŠ è—¤">åŠ è—¤</option><option value="éˆ´æœ¨">éˆ´æœ¨</option>
        <option value="æ˜Ÿé‡">æ˜Ÿé‡</option><option value="æ± ä¸Š">æ± ä¸Š</option>
        <option value="æ³‰æ°´">æ³‰æ°´</option><option value="ä¸Šå²¡">ä¸Šå²¡</option>
        <option value="å‰ç”°">å‰ç”°</option><option value="å €äº•">å €äº•</option>
        <option value="é«˜åŸ">é«˜åŸ</option><option value="æ‘å²¡">æ‘å²¡</option>
      </select>

      <p class="label">æ•°é‡</p>
      <select id="quantitySelect">
        <option value="">--é¸æŠã—ã¦ãã ã•ã„--</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
      </select>

      <p class="label">æ“ä½œç¨®åˆ¥</p>
      <button class="btn" onclick="submitData('å…¥åº«')">å…¥åº«</button>
      <button class="btn" onclick="submitData('å‡ºåº«')">å‡ºåº«</button>
      <button class="btn" onclick="returnToScanner()">ã‚«ãƒ¡ãƒ©ç”»é¢ã¸æˆ»ã‚‹</button>
    </div>

    <!-- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
    <div class="popup-overlay" id="popupOverlay">
      <div class="popup">
        <button class="popup-close" onclick="closePopup()">&times;</button>
        <div class="popup-header" id="popupHeader"></div>
        <div class="popup-content" id="popupContent"></div>
        <button class="popup-button" id="popupOkButton">OK</button>
        <button class="popup-button" id="restartButton" style="display:none;">QRèª­ã¿å–ã‚Šç”»é¢ã«æˆ»ã‚‹</button>
      </div>
    </div>
  </main>

<!-- ZXing ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.18.6/umd/index.min.js"></script>

<!-- ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
<script defer>
  /* ========== Apps Script ã®ãƒ‡ãƒ—ãƒ­ã‚¤ URL ========== */
  const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbyVJxEbB-IqzJkU1Hh3C1O_QZwkAIVGa1PI98YGdEAbqcldG6G_k_kb8w5KjOZfrjuODQ/exec';

/* ========== ç¢ºå®ŸãªSafariå¯¾å¿œ callApi é–¢æ•° ========== */
async function callApi(method, action, data = null) {
  console.log('=== callApiå‘¼ã³å‡ºã— ===');
  console.log('Method:', method);
  console.log('Action:', action);
  console.log('Data:', data);
  
  return new Promise((resolve, reject) => {
    const timestamp = Date.now();
    const random = Math.floor(Math.random() * 10000);
    const callbackName = 'gas_cb_' + timestamp + '_' + random;
    
    // URLã‚’æ§‹ç¯‰
    let url = API_BASE_URL + '?';
    const params = [];
    
    // callbackã‚’æœ€åˆã«è¿½åŠ 
    params.push('callback=' + encodeURIComponent(callbackName));
    params.push('action=' + encodeURIComponent(action));
    
    if (data) {
      Object.keys(data).forEach(key => {
        if (key !== 'action') {
          params.push(encodeURIComponent(key) + '=' + encodeURIComponent(data[key]));
        }
      });
    }
    
    // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¿½åŠ ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥é˜²æ­¢ï¼‰
    params.push('_=' + timestamp);
    
    url += params.join('&');
    
    let isResolved = false;
    let timeoutId;
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
    window[callbackName] = function(result) {
      if (isResolved) return;
      isResolved = true;
      
      console.log('JSONP success:', callbackName, result);
      clearTimeout(timeoutId);
      cleanup();
      resolve(result);
    };
    
    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–¢æ•°
    function cleanup() {
      try {
        const script = document.getElementById(callbackName);
        if (script && script.parentNode) {
          script.parentNode.removeChild(script);
        }
      } catch (e) {
        console.warn('Script cleanup failed:', e);
      }
      
      try {
        delete window[callbackName];
      } catch (e) {
        window[callbackName] = undefined;
      }
    }
    
    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
    timeoutId = setTimeout(() => {
      if (isResolved) return;
      isResolved = true;
      
      console.error('JSONP timeout:', callbackName);
      cleanup();
      reject(new Error('Request timeout after 30 seconds'));
    }, 30000);
    
    // ã‚¹ã‚¯ãƒªãƒ—ãƒˆè¦ç´ ä½œæˆ
    const script = document.createElement('script');
    script.id = callbackName;
    script.type = 'text/javascript';
    script.async = true;
    script.charset = 'utf-8';
    
    script.onerror = function(event) {
      if (isResolved) return;
      isResolved = true;
      
      console.error('JSONP script error:', event);
      clearTimeout(timeoutId);
      cleanup();
      reject(new Error('Script loading failed'));
    };
    
    script.onload = function() {
      console.log('JSONP script loaded:', callbackName);
    };
    
    console.log('JSONP request URL:', url);
    script.src = url;
    
    // DOM ã«è¿½åŠ 
    document.head.appendChild(script);
  });
}


/* ========== Safariè¨ºæ–­æ©Ÿèƒ½ ========== */
async function runSafariDiagnostics() {
  const diagnostics = {
    hasInternet: false,
    canReachGoogle: false,
    userAgent: navigator.userAgent,
    timestamp: new Date().toISOString()
  };
  
  try {
    // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãƒ†ã‚¹ãƒˆ
    const testResponse = await fetch('https://www.google.com/favicon.ico', {
      method: 'HEAD',
      mode: 'no-cors',
      cache: 'no-cache'
    });
    diagnostics.hasInternet = true;
    diagnostics.canReachGoogle = true;
  } catch (e) {
    console.log('Internet connectivity test failed:', e);
  }
  
  console.log('Safari diagnostics:', diagnostics);
  return diagnostics;
}

  /* --- ZXing ã‚’å–å¾—ï¼ˆSafari12 äº’æ›ï¼šåˆ†å‰²ä»£å…¥ã¯ä½¿ã‚ãªã„ï¼‰ --- */
  const BrowserQRCodeReader = ZXing.BrowserQRCodeReader;
  const NotFoundException   = ZXing.NotFoundException;

  /* ---------- ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ ---------- */
  let codeReader;
  let CURRENT_TEXT      = "";
  let currentItemName   = "";
  let selectedMode      = null;
  let currentStockOut   = 0;
  let currentStockVis   = 0;
  let preferredDeviceId = null; 

/* ---------- ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰å¾Œï¼ˆãƒ‡ãƒãƒƒã‚°ç‰ˆï¼‰ ---------- */
document.addEventListener('DOMContentLoaded', () => {
  // ãƒ–ãƒ©ã‚¦ã‚¶åˆ¤å®šã®ãƒ‡ãƒãƒƒã‚°
  const userAgent = navigator.userAgent;
  const isSafari = /^((?!chrome|android).)*safari/i.test(userAgent);
  
  console.log('=== ãƒ–ãƒ©ã‚¦ã‚¶åˆ¤å®šãƒ‡ãƒãƒƒã‚° ===');
  console.log('User Agent:', userAgent);
  console.log('Safariåˆ¤å®šçµæœ:', isSafari);
  console.log('Chromeå«ã‚€?:', userAgent.toLowerCase().includes('chrome'));
  console.log('Safariå«ã‚€?:', userAgent.toLowerCase().includes('safari'));
  
  // å¼·åˆ¶çš„ã«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆå…¨ãƒ–ãƒ©ã‚¦ã‚¶ã§ï¼‰
  console.log('æ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹ï¼ˆå…¨ãƒ–ãƒ©ã‚¦ã‚¶å¯¾è±¡ï¼‰');
  
  setTimeout(async () => {
    try {
      console.log('GASæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹...');
      
      // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ†ã‚¹ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ
      const testResult = await callApi('GET', 'test', { code: 'TEST' });
      console.log('æ¥ç¶šãƒ†ã‚¹ãƒˆçµæœ:', testResult);
      
      if (testResult && (testResult.success || testResult.test)) {
        console.log('âœ… GASæ¥ç¶šæˆåŠŸ');
        
        // ã‚¢ãƒ©ãƒ¼ãƒˆã®ä»£ã‚ã‚Šã«ç”»é¢ä¸Šéƒ¨ã«é€šçŸ¥ã‚’è¡¨ç¤º
        showConnectionSuccessNotification();
        
      } else {
        throw new Error('Invalid test response: ' + JSON.stringify(testResult));
      }
      
    } catch (error) {
      console.error('âŒ æ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—:', error);
      
      // ã‚¨ãƒ©ãƒ¼æ™‚ã®ã¿ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆé‡è¦ãªæƒ…å ±ãªã®ã§ï¼‰
      alert(`æ¥ç¶šãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼: ${error.message}\n\nã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
    }
  
  codeReader = new BrowserQRCodeReader(undefined, { delayBetweenScanAttempts: 200 });

  document.getElementById('startCameraBtn')
          .addEventListener('click', startScanner);

  document.getElementById('fileInput')
          .addEventListener('change', e => {
            const f = e.target.files[0];
            if (f) decodeFromFile(f);
  });
});

/* ---------- Safariæ¥ç¶šãƒ†ã‚¹ãƒˆ ---------- */
async function testSafariConnection() {
  try {
    console.log('Safari: æ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹');
    const testResult = await callApi('GET', 'getItemInfo', { code: 'TEST' });
    console.log('Safari: æ¥ç¶šãƒ†ã‚¹ãƒˆçµæœ', testResult);
  } catch (error) {
    console.error('Safari: æ¥ç¶šãƒ†ã‚¹ãƒˆã«å¤±æ•—', error);
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥
    alert('Safariæ¥ç¶šãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†èª­ã¿è¾¼ã¿ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚');
  }
}

  /* ---------- åˆ¤å®šï¼šã‚«ãƒ¡ãƒ© API ãŒã‚ã‚‹ï¼Ÿ ---------- */
  function hasCamera () {
    return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
  }

  /* ---------- ã‚¹ã‚­ãƒ£ãƒŠãƒ¼èµ·å‹• ---------- */
  async function startScanner () {
    if (!hasCamera()) return document.getElementById('fileInput').click();

    const cams = await codeReader.listVideoInputDevices();

    // â¶ èƒŒé¢ã‚«ãƒ¡ãƒ©ã‚’å„ªå…ˆã€‚ãŸã ã—è¨˜æ†¶ã—ã¦ã„ã‚‹ã‚‚ã®ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†
    let deviceId = preferredDeviceId;
    if (!deviceId) {
      deviceId = (cams.find(c => /back|rear|environment/i.test(c.label)) || cams[0] || {}).deviceId;
      preferredDeviceId = deviceId;    // è¦šãˆã‚‹
    }

    codeReader.decodeFromVideoDevice(deviceId, 'reader', (res, err) => {
      if (res) {
        onScanSuccess(res.getText());
        codeReader.reset();
      } else if (err && !(err instanceof NotFoundException)) {
        // â· err ãŒ undefined ãªã‚‰ä½•ã‚‚ã—ãªã„
        if (err && err.message) {
          alert('ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: ' + err.message);
        }
      }
    });
  }

  /* ---------- ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿å–ã‚Š ---------- */
  async function decodeFromFile (file) {
    try {
      const r = await codeReader.decodeFromImage(file);
      onScanSuccess(r.getText());
    } catch (e) {
      alert('ç”»åƒã‹ã‚‰ QR ã‚’æ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ');
    }
  }

/* ========== æ”¹è‰¯ã•ã‚ŒãŸonScanSuccess ========== */
async function onScanSuccess(decodedText) {
  if (CURRENT_TEXT === decodedText) return;
  CURRENT_TEXT = decodedText;
  document.getElementById("result").textContent = `QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šå®Œäº†: ${decodedText}`;
  document.getElementById("formArea").classList.remove("hidden");
  document.getElementById("codeDisplay").textContent = decodedText;

  try {
    console.log('ã‚¢ã‚¤ãƒ†ãƒ æƒ…å ±å–å¾—é–‹å§‹', decodedText);
    const info = await callApi('GET', 'getItemInfo', { code: decodedText });
    console.log('ã‚¢ã‚¤ãƒ†ãƒ æƒ…å ±å–å¾—çµæœ', info);
    
    if (!info || (!info.name && !info.error)) {
      console.error('äºˆæœŸã—ãªã„å¿œç­”å½¢å¼', info);
      showErrorPopup("ã‚¨ãƒ©ãƒ¼", "ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰äºˆæœŸã—ãªã„å¿œç­”ãŒã‚ã‚Šã¾ã—ãŸ", returnToScanner);
      return;
    }
    
    if (info.error || !info.name) {
      console.log('ã‚¢ã‚¤ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', info);
      showErrorPopup("ã‚¨ãƒ©ãƒ¼", "ã‚³ãƒ¼ãƒ‰ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å­˜åœ¨ã—ã¾ã›ã‚“", returnToScanner);
      return;
    }
    
    currentItemName = info.name;
    currentStockOut = Number(info.stockOut) || 0;
    currentStockVis = Number(info.stockVis) || 0;
    document.getElementById("itemNameDisplay").textContent = info.name;
    document.getElementById("stockDisplay").textContent = "";
    
    console.log('ã‚¢ã‚¤ãƒ†ãƒ æƒ…å ±è¨­å®šå®Œäº†', {
      name: currentItemName,
      stockOut: currentStockOut,
      stockVis: currentStockVis
    });
    
  } catch (error) {
    console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼', error);
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    const errorMsg = isSafari 
      ? "Safarié€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼šè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„" 
      : "ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ";
    showErrorPopup("ã‚¨ãƒ©ãƒ¼", errorMsg, returnToScanner);
  }
}

  /* ---------- ãƒ¢ãƒ¼ãƒ‰é¸æŠ ---------- */
  window.setMode = function setMode(mode, btn){
    selectedMode = mode;
    // ãƒœã‚¿ãƒ³è¡¨ç¤ºåˆ‡æ›¿
    document.querySelectorAll('#modeSelect .mode-btn')
            .forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    // åœ¨åº«è¡¨ç¤ºã‚’æ›´æ–°
    const stock = mode === 'è¨ªå•' ? currentStockVis : currentStockOut;
    const sd    = document.getElementById('stockDisplay');
    if (sd){
      sd.textContent = stock;
      stock === 0 ? sd.classList.add('zero') : sd.classList.remove('zero');
    }
  };

  function resetModeUI(){
    selectedMode = null;
    document.querySelectorAll('#modeSelect .mode-btn')
            .forEach(b => b.classList.remove('active'));
    const sd = document.getElementById('stockDisplay');
    if (sd) sd.textContent = '';
  }

  /* ---------- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— ---------- */
  function showPopup(title,msg,okCb){
    document.getElementById('popupHeader').textContent = title;
    document.getElementById('popupContent').textContent = msg;
    document.getElementById('popupOverlay').style.display='flex';
    document.getElementById('popupOkButton').style.display='inline-block';
    document.getElementById('restartButton').style.display='none';
    document.getElementById('popupOkButton').onclick=()=>{closePopup();okCb&&okCb();};
  }
  function showErrorPopup(title,msg,okCb){
    document.getElementById('popupHeader').textContent = title;
    document.getElementById('popupContent').textContent = msg;
    document.getElementById('popupOverlay').style.display='flex';
    document.getElementById('popupOkButton').style.display='none';
    document.getElementById('restartButton').style.display='inline-block';
    document.getElementById('restartButton').onclick=()=>{closePopup();okCb&&okCb();};
  }
  function closePopup(){
    document.getElementById('popupOverlay').style.display='none';
  }

  /* ---------- ã‚«ãƒ¡ãƒ©ç”»é¢ã¸æˆ»ã‚‹ ---------- */
  function returnToScanner(){
    document.getElementById("formArea").classList.add("hidden");
    document.getElementById("result").textContent="";
    document.getElementById("itemNameDisplay").textContent="";
    CURRENT_TEXT="";
    resetModeUI();
    startScanner(); 
  }

  /* ---------- ãƒ‡ãƒ¼ã‚¿é€ä¿¡ ---------- */
/* ---------- ãƒ‡ãƒ¼ã‚¿é€ä¿¡ ---------- */
async function submitData(operation) {
  const staff = document.getElementById("staffSelect").value;
  const quantity = document.getElementById("quantitySelect").value;

  if (!staff || !quantity || !selectedMode) {
    alert("ã‚¹ã‚¿ãƒƒãƒ•åãƒ»æ•°é‡ãƒ»ç”¨é€”ï¼ˆå¤–æ¥/è¨ªå•ï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼");
    return;
  }

  const confirmMsg = `${currentItemName} ã‚’ ${quantity}å€‹ã€${operation} ã—ã¾ã™ã‹ï¼Ÿ`;
  showPopup("ç¢ºèª", confirmMsg, async () => {
    try {
      const data = {
        code: CURRENT_TEXT,
        operation,
        staff,
        quantity,
        mode: selectedMode
      };
      
      let response = await callApi('GET', 'appendLog', data);

      if (response.result === 'confirm') {
        showConfirmPopup(
          "ç¢ºèª",
          response.message,
          async () => {             // YES
            try {
              // ç¢ºèªãƒ•ãƒ©ã‚°ã‚’ä»˜ã‘ã¦å†é€ä¿¡
              const confirmedData = {
                code: CURRENT_TEXT,
                operation,
                staff,
                quantity,
                mode: selectedMode,
                confirmed: 'true'  // ç¢ºèªãƒ•ãƒ©ã‚°ã‚’è¿½åŠ 
              };
              const confirmedResponse = await callApi('GET', 'appendLog', confirmedData);
              handleFinalResponse(confirmedResponse);
            } catch (error) {
              console.error('ç¢ºèªå¾Œã®APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', error);
              showErrorPopup("ã‚¨ãƒ©ãƒ¼", "ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ", returnToScanner);
            }
          },
          returnToScanner           // NO
        );
        return;                     // ã„ã£ãŸã‚“æŠœã‘ã‚‹
      }
      
      if (response.result === 'success') {
        showPopup("æ›´æ–°å®Œäº†", response.message, () => {
          document.getElementById("staffSelect").value = "";
          document.getElementById("quantitySelect").value = "";
          document.getElementById("result").textContent = "";
          document.getElementById("formArea").classList.add("hidden");
          document.getElementById("itemNameDisplay").textContent = "";
          CURRENT_TEXT = "";
          resetModeUI();
        });
      } else {
        showErrorPopup("ã‚¨ãƒ©ãƒ¼", response.message || "æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ", returnToScanner);
      }
    } catch (error) {
      console.error('åˆå›APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', error);
      showErrorPopup("ã‚¨ãƒ©ãƒ¼", "ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ", returnToScanner);
    }
  });
}
  
  function handleFinalResponse(response){
    if (response.result === 'success'){
      showPopup("æ›´æ–°å®Œäº†", response.message, () => {
        /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ åˆæœŸåŒ–ãªã© */
        document.getElementById("staffSelect").value = "";
        document.getElementById("quantitySelect").value = "";
        document.getElementById("result").textContent = "";
        document.getElementById("formArea").classList.add("hidden");
        document.getElementById("itemNameDisplay").textContent = "";
        CURRENT_TEXT = "";
        resetModeUI();
      });
    } else {
      showErrorPopup("ã‚¨ãƒ©ãƒ¼", response.message || "æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ", returnToScanner);
    }
  }
  
  function showConfirmPopup(title, msg, yesCb, noCb){
    document.getElementById('popupHeader').textContent = title;
    document.getElementById('popupContent').textContent = msg;
    document.getElementById('popupOverlay').style.display = 'flex';

    // ã€Œã¯ã„ã€ãƒœã‚¿ãƒ³ï¼ˆOKï¼‰ã‚’è¡¨ç¤º
    const okBtn = document.getElementById('popupOkButton');
    okBtn.style.display = 'inline-block';
    okBtn.textContent = 'ã¯ã„';
    okBtn.onclick = () => { closePopup(); yesCb && yesCb(); };

    // ã€Œã„ã„ãˆã€ãƒœã‚¿ãƒ³ï¼ˆrestartï¼‰ã‚’è¡¨ç¤º
    const noBtn = document.getElementById('restartButton');
    noBtn.style.display = 'inline-block';
    noBtn.textContent = 'ã„ã„ãˆ';
    noBtn.onclick = () => { closePopup(); noCb && noCb(); };
  }
  /* ---------- æ¥ç¶šæˆåŠŸé€šçŸ¥ ---------- */
function showConnectionSuccessNotification() {
  // é€šçŸ¥ãƒãƒŠãƒ¼ä½œæˆ
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(90deg, #4caf50, #2e7d32);
    color: white;
    padding: 12px 20px;
    text-align: center;
    font-size: 16px;
    font-weight: bold;
    z-index: 9999;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    transform: translateY(-100%);
    transition: transform 0.3s ease;
  `;
  notification.textContent = 'âœ… ã‚·ã‚¹ãƒ†ãƒ æ¥ç¶šæˆåŠŸï¼æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™';
  
  document.body.appendChild(notification);
  
  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
  setTimeout(() => {
    notification.style.transform = 'translateY(0)';
  }, 100);
  
  // 3ç§’å¾Œã«è‡ªå‹•éè¡¨ç¤º
  setTimeout(() => {
    notification.style.transform = 'translateY(-100%)';
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  }, 3000);
}
</script>
</body>
</html>
