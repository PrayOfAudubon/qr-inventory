<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>在庫管理アプリ</title>

  <style>
/* ========== 共通レイアウト ========== */
body{
  font-family:'Segoe UI','Helvetica Neue',sans-serif;
  background:#f4f6fa;margin:0;padding:0;font-size:22px;
}
header{
  background:linear-gradient(90deg,#42a5f5,#1e88e5);
  color:#fff;text-align:center;padding:28px 20px;
  box-shadow:0 2px 6px rgba(0,0,0,.2);
}
header h2{font-size:28px;line-height:1.8;margin:0;text-shadow:1px 1px 3px rgba(0,0,0,.2);}
main{width:100vw;padding:24px;box-sizing:border-box;}

#reader{
  margin:20px 0;padding:24px;background:#fff;border-radius:16px;
  box-shadow:0 2px 8px rgba(0,0,0,.08);width:100%;
}
#formArea{
  padding:32px 24px;background:#fff;
  border:1px solid #e0e0e0;border-radius:20px;
  box-shadow:0 8px 24px rgba(0,0,0,.06);margin-top:24px;
}

/* ========== "ラベル:値" を 2 列グリッドで ========== */
.field{
  display:grid;grid-template-columns:max-content 1fr;align-items:center;
  column-gap:12px;background:#fff;border:1px solid #e0e0e0;border-radius:12px;
  padding:14px 18px;margin:16px 0;
}
.label{
  font-weight:700;font-size:22px;white-space:nowrap;margin:0;
}
.value{
  font-weight:600;font-size:22px;color:#1565c0;margin:0;word-break:break-all;
}

/* ========== 在庫ゼロで点滅 ========== */
#stockDisplay.zero{color:#e91e63;animation:blink 1s steps(2,start) infinite;}
@keyframes blink{to{visibility:hidden;}}

/* ========== セレクト・ボタン ========== */
select, input[type="number"]{
  width:100%;padding:18px;font-size:22px;border-radius:14px;
  border:1px solid #ccc;margin:22px 0 0;box-shadow:inset 0 1px 2px rgba(0,0,0,.04);
  box-sizing:border-box;
}
.btn{
  display:block;width:100%;padding:18px;margin:14px 0;font-size:22px;
  color:#fff;border:none;border-radius:32px;cursor:pointer;
  background:linear-gradient(90deg,#42a5f5,#1e88e5);
  box-shadow:0 4px 6px rgba(0,0,0,.1);transition:transform .1s ease;
}
.btn:hover{transform:translateY(-2px);background:linear-gradient(90deg,#1e88e5,#1565c0);}

/* 用途ボタン強調 */
.mode-btn      {background:#1e88e5;}
.mode-btn:hover{background:#1565c0;}
.mode-btn.active{
  background:#ef5350;box-shadow:0 0 0 3px #ffcdd2 inset;
}
/* 黒いフォーカス枠を消す */
.mode-btn:focus{outline:none;}

/* ========== ポップアップ ========== */
.popup-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.4);
  display:none;justify-content:center;align-items:center;z-index:1000;
}
.popup{
  background:#fff;border-radius:20px;padding:28px;width:90%;max-width:420px;
  box-shadow:0 4px 16px rgba(0,0,0,.2);text-align:center;
}
.popup-header{font-size:26px;font-weight:bold;margin-bottom:14px;}
.popup-content{font-size:22px;margin-bottom:24px;}
.popup-button,.popup-close{
  background:#42a5f5;border:none;color:#fff;padding:16px 28px;font-size:22px;
  border-radius:32px;cursor:pointer;margin:8px 0;
}
.popup-button:hover{background:#1e88e5;}
.popup-close{
  position:absolute;top:10px;right:14px;background:none;color:#999;font-size:26px;
}
.popup-close:hover{color:#666;}

.hidden{display:none!important;}

  </style>
</head>
<body>
  <header>
    <h2>QRコードを読み込んでください</h2>
  </header>

  <main>
  <!-- ① QR プレビュー領域 -->
  <video id="reader" playsinline muted></video>
  <div id="result" style="margin-top:8px;color:#089;">読み取り待機中…</div>

  <!-- ② カメラ開始ボタン & 画像フォールバック -->
  <button id="startCameraBtn" class="btn">カメラを起動</button>
  <input id="fileInput"
         type="file"
         accept="image/*"
         capture="environment"
         class="hidden">

    <div id="formArea" class="hidden">
      <div class="field">
        <span class="label">読み取った品目コード：</span>
        <span id="codeDisplay" class="value"></span>
      </div>

      <!-- 用途選択 -->
      <p class="label">用途選択</p>
      <div id="modeSelect">
        <button class="btn mode-btn" onclick="setMode('外来', this)">外来用</button>
        <button class="btn mode-btn" onclick="setMode('訪問', this)">訪問用</button>
      </div>

      <div class="field">
        <span class="label">品目名：</span>
        <span id="itemNameDisplay" class="value"></span>
      </div>

      <div class="field">
        <span class="label">在庫数：</span>
        <span id="stockDisplay" class="value"></span>
      </div>

      <p class="label">スタッフ名</p>
      <select id="staffSelect">
        <option value="">--選択してください--</option>
        <option value="渡会">渡会</option><option value="山崎">山崎</option>
        <option value="中野">中野</option><option value="桶川">桶川</option>
        <option value="加藤">加藤</option><option value="鈴木">鈴木</option>
        <option value="星野">星野</option><option value="池上">池上</option>
        <option value="泉水">泉水</option><option value="上岡">上岡</option>
        <option value="吉田">吉田</option><option value="堀井">堀井</option>
        <option value="高原">高原</option><option value="村岡">村岡</option>
      </select>

      <!-- 数量 -->
      <label for="quantityInput" class="label">数量</label>
      <input
        id="quantityInput"
        type="number"
        inputmode="numeric"  
        min="1"              
        step="1"              
        placeholder="数量を入力"
        required             
        onwheel="return false;" 
      />


      <p class="label">操作種別</p>
      <button class="btn" onclick="submitData('入庫')">入庫</button>
      <button class="btn" onclick="submitData('出庫')">出庫</button>
      <button class="btn" onclick="returnToScanner()">カメラ画面へ戻る</button>
    </div>

    <!-- ポップアップ -->
    <div class="popup-overlay" id="popupOverlay">
      <div class="popup">
        <button class="popup-close" onclick="closePopup()">&times;</button>
        <div class="popup-header" id="popupHeader"></div>
        <div class="popup-content" id="popupContent"></div>
        <button class="popup-button" id="popupOkButton">OK</button>
        <button class="popup-button" id="restartButton" style="display:none;">QR読み取り画面に戻る</button>
      </div>
    </div>
  </main>

<!-- ZXing ライブラリ -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.18.6/umd/index.min.js"></script>

<!-- メインスクリプト -->
<script defer>
  /* ========== Apps Script のデプロイ URL ========== */
  const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbyVJxEbB-IqzJkU1Hh3C1O_QZwkAIVGa1PI98YGdEAbqcldG6G_k_kb8w5KjOZfrjuODQ/exec';

/* ========== 確実なSafari対応 callApi 関数 ========== */
async function callApi(method, action, data = null) {
  console.log('=== callApi呼び出し ===');
  console.log('Method:', method);
  console.log('Action:', action);
  console.log('Data:', data);
  
  return new Promise((resolve, reject) => {
    const timestamp = Date.now();
    const random = Math.floor(Math.random() * 10000);
    const callbackName = 'gas_cb_' + timestamp + '_' + random;
    
    // URLを構築
    let url = API_BASE_URL + '?';
    const params = [];
    
    // callbackを最初に追加
    params.push('callback=' + encodeURIComponent(callbackName));
    params.push('action=' + encodeURIComponent(action));
    
    if (data) {
      Object.keys(data).forEach(key => {
        if (key !== 'action') {
          params.push(encodeURIComponent(key) + '=' + encodeURIComponent(data[key]));
        }
      });
    }
    
    // タイムスタンプを追加（キャッシュ防止）
    params.push('_=' + timestamp);
    
    url += params.join('&');
    
    let isResolved = false;
    let timeoutId;
    
    // グローバルコールバック関数
    window[callbackName] = function(result) {
      if (isResolved) return;
      isResolved = true;
      
      console.log('JSONP success:', callbackName, result);
      clearTimeout(timeoutId);
      cleanup();
      resolve(result);
    };
    
    // クリーンアップ関数
    function cleanup() {
      try {
        const script = document.getElementById(callbackName);
        if (script && script.parentNode) {
          script.parentNode.removeChild(script);
        }
      } catch (e) {
        console.warn('Script cleanup failed:', e);
      }
      
      try {
        delete window[callbackName];
      } catch (e) {
        window[callbackName] = undefined;
      }
    }
    
    // タイムアウト設定
    timeoutId = setTimeout(() => {
      if (isResolved) return;
      isResolved = true;
      
      console.error('JSONP timeout:', callbackName);
      cleanup();
      reject(new Error('Request timeout after 30 seconds'));
    }, 30000);
    
    // スクリプト要素作成
    const script = document.createElement('script');
    script.id = callbackName;
    script.type = 'text/javascript';
    script.async = true;
    script.charset = 'utf-8';
    
    script.onerror = function(event) {
      if (isResolved) return;
      isResolved = true;
      
      console.error('JSONP script error:', event);
      clearTimeout(timeoutId);
      cleanup();
      reject(new Error('Script loading failed'));
    };
    
    script.onload = function() {
      console.log('JSONP script loaded:', callbackName);
    };
    
    console.log('JSONP request URL:', url);
    script.src = url;
    
    // DOM に追加
    document.head.appendChild(script);
  });
}


/* ========== Safari診断機能 ========== */
async function runSafariDiagnostics() {
  const diagnostics = {
    hasInternet: false,
    canReachGoogle: false,
    userAgent: navigator.userAgent,
    timestamp: new Date().toISOString()
  };
  
  try {
    // インターネット接続テスト
    const testResponse = await fetch('https://www.google.com/favicon.ico', {
      method: 'HEAD',
      mode: 'no-cors',
      cache: 'no-cache'
    });
    diagnostics.hasInternet = true;
    diagnostics.canReachGoogle = true;
  } catch (e) {
    console.log('Internet connectivity test failed:', e);
  }
  
  console.log('Safari diagnostics:', diagnostics);
  return diagnostics;
}

  /* --- ZXing を取得（Safari12 互換：分割代入は使わない） --- */
  const BrowserQRCodeReader = ZXing.BrowserQRCodeReader;
  const NotFoundException   = ZXing.NotFoundException;

  /* ---------- グローバル状態 ---------- */
  let codeReader;
  let CURRENT_TEXT      = "";
  let currentItemName   = "";
  let selectedMode      = null;
  let currentStockOut   = 0;
  let currentStockVis   = 0;
  let preferredDeviceId = null; 

/* ---------- ページロード後（デバッグ版） ---------- */
document.addEventListener('DOMContentLoaded', () => {
  // ブラウザ判定のデバッグ
  const userAgent = navigator.userAgent;
  const isSafari = /^((?!chrome|android).)*safari/i.test(userAgent);
  
  console.log('=== ブラウザ判定デバッグ ===');
  console.log('User Agent:', userAgent);
  console.log('Safari判定結果:', isSafari);
  console.log('Chrome含む?:', userAgent.toLowerCase().includes('chrome'));
  console.log('Safari含む?:', userAgent.toLowerCase().includes('safari'));
  
  // 強制的にテスト実行（全ブラウザで）
  console.log('接続テスト開始（全ブラウザ対象）');
  
  setTimeout(async () => {
    try {
      console.log('GAS接続テスト開始...');
      
      // シンプルなテストリクエスト
      const testResult = await callApi('GET', 'test', { code: 'TEST' });
      console.log('接続テスト結果:', testResult);
      
      if (testResult && (testResult.success || testResult.test)) {
        console.log('✅ GAS接続成功');
        
        // アラートの代わりに画面上部に通知を表示
        showConnectionSuccessNotification();
        
      } else {
        throw new Error('Invalid test response: ' + JSON.stringify(testResult));
      }
      
    } catch (error) {
      console.error('❌ 接続テスト失敗:', error);
      
      // エラー時のみアラート（重要な情報なので）
      alert(`接続テストに失敗しました。\n\nエラー: ${error.message}\n\nコンソールログを確認してください。`);
    }
   }, 2000); 
  
  codeReader = new BrowserQRCodeReader(undefined, { delayBetweenScanAttempts: 200 });

  document.getElementById('startCameraBtn')
          .addEventListener('click', startScanner);

  document.getElementById('fileInput')
          .addEventListener('change', e => {
            const f = e.target.files[0];
            if (f) decodeFromFile(f);
  });
});

/* ---------- Safari接続テスト ---------- */
async function testSafariConnection() {
  try {
    console.log('Safari: 接続テスト開始');
    const testResult = await callApi('GET', 'getItemInfo', { code: 'TEST' });
    console.log('Safari: 接続テスト結果', testResult);
  } catch (error) {
    console.error('Safari: 接続テストに失敗', error);
    // ユーザーに通知
    alert('Safari接続テストに失敗しました。再読み込みをお試しください。');
  }
}

  /* ---------- 判定：カメラ API がある？ ---------- */
  function hasCamera () {
    return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
  }

  /* ---------- スキャナー起動 ---------- */
  async function startScanner () {
    if (!hasCamera()) return document.getElementById('fileInput').click();

    const cams = await codeReader.listVideoInputDevices();

    // ❶ 背面カメラを優先。ただし記憶しているものがあればそれを使う
    let deviceId = preferredDeviceId;
    if (!deviceId) {
      deviceId = (cams.find(c => /back|rear|environment/i.test(c.label)) || cams[0] || {}).deviceId;
      preferredDeviceId = deviceId;    // 覚える
    }

    codeReader.decodeFromVideoDevice(deviceId, 'reader', (res, err) => {
      if (res) {
        onScanSuccess(res.getText());
        codeReader.reset();
      } else if (err && !(err instanceof NotFoundException)) {
        // ❷ err が undefined なら何もしない
        if (err && err.message) {
          alert('カメラエラー: ' + err.message);
        }
      }
    });
  }

  /* ---------- 画像ファイル読み取り ---------- */
  async function decodeFromFile (file) {
    try {
      const r = await codeReader.decodeFromImage(file);
      onScanSuccess(r.getText());
    } catch (e) {
      alert('画像から QR を検出できませんでした');
    }
  }

/* ========== 改良されたonScanSuccess ========== */
async function onScanSuccess(decodedText) {
  if (CURRENT_TEXT === decodedText) return;
  CURRENT_TEXT = decodedText;
  document.getElementById("result").textContent = `QRコード読み取り完了: ${decodedText}`;
  document.getElementById("formArea").classList.remove("hidden");
  document.getElementById("codeDisplay").textContent = decodedText;

  try {
    console.log('アイテム情報取得開始', decodedText);
    const info = await callApi('GET', 'getItemInfo', { code: decodedText });
    console.log('アイテム情報取得結果', info);
    
    if (!info || (!info.name && !info.error)) {
      console.error('予期しない応答形式', info);
      showErrorPopup("エラー", "サーバーから予期しない応答がありました", returnToScanner);
      return;
    }
    
    if (info.error || !info.name) {
      console.log('アイテムが見つかりません', info);
      showErrorPopup("エラー", "コードがデータベースに存在しません", returnToScanner);
      return;
    }
    
    currentItemName = info.name;
    currentStockOut = Number(info.stockOut) || 0;
    currentStockVis = Number(info.stockVis) || 0;
    document.getElementById("itemNameDisplay").textContent = info.name;
    document.getElementById("stockDisplay").textContent = "";
    
    console.log('アイテム情報設定完了', {
      name: currentItemName,
      stockOut: currentStockOut,
      stockVis: currentStockVis
    });
    
  } catch (error) {
    console.error('データ取得エラー', error);
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    const errorMsg = isSafari 
      ? "Safari通信エラー：設定を確認してください" 
      : "データの取得に失敗しました";
    showErrorPopup("エラー", errorMsg, returnToScanner);
  }
}

  /* ---------- モード選択 ---------- */
  window.setMode = function setMode(mode, btn){
    selectedMode = mode;
    // ボタン表示切替
    document.querySelectorAll('#modeSelect .mode-btn')
            .forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    // 在庫表示を更新
    const stock = mode === '訪問' ? currentStockVis : currentStockOut;
    const sd    = document.getElementById('stockDisplay');
    if (sd){
      sd.textContent = stock;
      stock === 0 ? sd.classList.add('zero') : sd.classList.remove('zero');
    }
  };

  function resetModeUI(){
    selectedMode = null;
    document.querySelectorAll('#modeSelect .mode-btn')
            .forEach(b => b.classList.remove('active'));
    const sd = document.getElementById('stockDisplay');
    if (sd) sd.textContent = '';
  }

  /* ---------- ポップアップ ---------- */
  function showPopup(title,msg,okCb){
    document.getElementById('popupHeader').textContent = title;
    document.getElementById('popupContent').textContent = msg;
    document.getElementById('popupOverlay').style.display='flex';
    document.getElementById('popupOkButton').style.display='inline-block';
    document.getElementById('restartButton').style.display='none';
    document.getElementById('popupOkButton').onclick=()=>{closePopup();okCb&&okCb();};
  }
  function showErrorPopup(title,msg,okCb){
    document.getElementById('popupHeader').textContent = title;
    document.getElementById('popupContent').textContent = msg;
    document.getElementById('popupOverlay').style.display='flex';
    document.getElementById('popupOkButton').style.display='none';
    document.getElementById('restartButton').style.display='inline-block';
    document.getElementById('restartButton').onclick=()=>{closePopup();okCb&&okCb();};
  }
  function closePopup(){
    document.getElementById('popupOverlay').style.display='none';
  }

  /* ---------- カメラ画面へ戻る ---------- */
  function returnToScanner(){
    document.getElementById("formArea").classList.add("hidden");
    document.getElementById("result").textContent="";
    document.getElementById("itemNameDisplay").textContent="";
    CURRENT_TEXT="";
    resetModeUI();
    startScanner(); 
  }

  /* ---------- データ送信 ---------- */
async function submitData(operation) {
  const staff = document.getElementById("staffSelect").value;
  const qtyInput = document.getElementById('quantityInput');

  function getQuantity() {
    const val = qtyInput.value.trim();       // 文字列
    const quantity = Number(val);            // 数値に変換
  
    // バリデーション: 整数 & 1以上
    if (!Number.isInteger(quantity) || quantity <= 0) {
      alert('数量は 1 以上の整数で入力してください');
      qtyInput.focus();
      return null;
    }
    return quantity;
  }

  const confirmMsg = `${currentItemName} を ${quantity}個、${operation} しますか？`;
  showPopup("確認", confirmMsg, async () => {
    try {
      const data = {
        code: CURRENT_TEXT,
        operation,
        staff,
        quantity,
        mode: selectedMode
      };
      
      let response = await callApi('GET', 'appendLog', data);

      if (response.result === 'confirm') {
        showConfirmPopup(
          "確認",
          response.message,
          async () => {             // YES
            try {
              // 確認フラグを付けて再送信
              const confirmedData = {
                code: CURRENT_TEXT,
                operation,
                staff,
                quantity,
                mode: selectedMode,
                confirmed: 'true'  // 確認フラグを追加
              };
              const confirmedResponse = await callApi('GET', 'appendLog', confirmedData);
              handleFinalResponse(confirmedResponse);
            } catch (error) {
              console.error('確認後のAPI呼び出しエラー:', error);
              showErrorPopup("エラー", "サーバーとの通信に失敗しました", returnToScanner);
            }
          },
          returnToScanner           // NO
        );
        return;                     // いったん抜ける
      }
      
      if (response.result === 'success') {
        showPopup("更新完了", response.message, () => {
          document.getElementById("staffSelect").value = "";
          document.getElementById("quantitySelect").value = "";
          document.getElementById("result").textContent = "";
          document.getElementById("formArea").classList.add("hidden");
          document.getElementById("itemNameDisplay").textContent = "";
          CURRENT_TEXT = "";
          resetModeUI();
        });
      } else {
        showErrorPopup("エラー", response.message || "更新に失敗しました", returnToScanner);
      }
    } catch (error) {
      console.error('初回API呼び出しエラー:', error);
      showErrorPopup("エラー", "サーバーとの通信に失敗しました", returnToScanner);
    }
  });
}
  
  function handleFinalResponse(response){
    if (response.result === 'success'){
      showPopup("更新完了", response.message, () => {
        /* 入力フォーム初期化など */
        document.getElementById("staffSelect").value = "";
        document.getElementById("quantitySelect").value = "";
        document.getElementById("result").textContent = "";
        document.getElementById("formArea").classList.add("hidden");
        document.getElementById("itemNameDisplay").textContent = "";
        CURRENT_TEXT = "";
        resetModeUI();
      });
    } else {
      showErrorPopup("エラー", response.message || "更新に失敗しました", returnToScanner);
    }
  }
  
  function showConfirmPopup(title, msg, yesCb, noCb){
    document.getElementById('popupHeader').textContent = title;
    document.getElementById('popupContent').textContent = msg;
    document.getElementById('popupOverlay').style.display = 'flex';

    // 「はい」ボタン（OK）を表示
    const okBtn = document.getElementById('popupOkButton');
    okBtn.style.display = 'inline-block';
    okBtn.textContent = 'はい';
    okBtn.onclick = () => { closePopup(); yesCb && yesCb(); };

    // 「いいえ」ボタン（restart）を表示
    const noBtn = document.getElementById('restartButton');
    noBtn.style.display = 'inline-block';
    noBtn.textContent = 'いいえ';
    noBtn.onclick = () => { closePopup(); noCb && noCb(); };
  }
  /* ---------- 接続成功通知 ---------- */
function showConnectionSuccessNotification() {
  // 通知バナー作成
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(90deg, #4caf50, #2e7d32);
    color: white;
    padding: 12px 20px;
    text-align: center;
    font-size: 16px;
    font-weight: bold;
    z-index: 9999;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    transform: translateY(-100%);
    transition: transform 0.3s ease;
  `;
  notification.textContent = '✅ システム接続成功！正常に動作しています';
  
  document.body.appendChild(notification);
  
  // アニメーション表示
  setTimeout(() => {
    notification.style.transform = 'translateY(0)';
  }, 100);
  
  // 3秒後に自動非表示
  setTimeout(() => {
    notification.style.transform = 'translateY(-100%)';
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  }, 3000);
}
</script>
</body>
</html>
