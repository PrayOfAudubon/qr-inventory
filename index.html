<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>在庫管理アプリ</title>

  <style>
/* ========== 共通レイアウト ========== */
body{
  font-family:'Segoe UI','Helvetica Neue',sans-serif;
  background:#f4f6fa;margin:0;padding:0;font-size:22px;
}
header{
  background:linear-gradient(90deg,#42a5f5,#1e88e5);
  color:#fff;text-align:center;padding:28px 20px;
  box-shadow:0 2px 6px rgba(0,0,0,.2);
}
header h2{font-size:28px;line-height:1.8;margin:0;text-shadow:1px 1px 3px rgba(0,0,0,.2);}
main{width:100vw;padding:24px;box-sizing:border-box;}

#reader{
  margin:20px 0;padding:24px;background:#fff;border-radius:16px;
  box-shadow:0 2px 8px rgba(0,0,0,.08);width:100%;
}
#formArea{
  padding:32px 24px;background:#fff;
  border:1px solid #e0e0e0;border-radius:20px;
  box-shadow:0 8px 24px rgba(0,0,0,.06);margin-top:24px;
}

/* ========== "ラベル:値" を 2 列グリッドで ========== */
.field{
  display:grid;grid-template-columns:max-content 1fr;align-items:center;
  column-gap:12px;background:#fff;border:1px solid #e0e0e0;border-radius:12px;
  padding:14px 18px;margin:16px 0;
}
.label{
  font-weight:700;font-size:22px;white-space:nowrap;margin:0;
}
.value{
  font-weight:600;font-size:22px;color:#1565c0;margin:0;word-break:break-all;
}

/* ========== 在庫ゼロで点滅 ========== */
#stockDisplay.zero{color:#e91e63;animation:blink 1s steps(2,start) infinite;}
@keyframes blink{to{visibility:hidden;}}

/* ========== セレクト・ボタン・インプット ========== */
select, input[type="number"]{
  width:100%;padding:18px;font-size:22px;border-radius:14px;
  border:1px solid #ccc;margin:22px 0 0;box-shadow:inset 0 1px 2px rgba(0,0,0,.04);
  box-sizing:border-box;
}
.btn{
  display:block;width:100%;padding:18px;margin:14px 0;font-size:22px;
  color:#fff;border:none;border-radius:32px;cursor:pointer;
  background:linear-gradient(90deg,#42a5f5,#1e88e5);
  box-shadow:0 4px 6px rgba(0,0,0,.1);transition:transform .1s ease;
  -webkit-appearance: none;
  -webkit-tap-highlight-color: transparent;
}
.btn:active{transform:translateY(1px);background:linear-gradient(90deg,#1e88e5,#1565c0);}

/* 用途ボタン強調 */
.mode-btn      {background:#1e88e5;}
.mode-btn.active{
  background:#ef5350;box-shadow:0 0 0 3px #ffcdd2 inset;
}
/* 黒いフォーカス枠を消す */
.mode-btn:focus{outline:none;}

/* ========== ポップアップ ========== */
.popup-overlay{
  position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);
  display:none;justify-content:center;align-items:center;z-index:1000;
}
.popup{
  background:#fff;border-radius:20px;padding:28px;width:90%;max-width:420px;
  box-shadow:0 4px 16px rgba(0,0,0,.3);text-align:center;
  position: relative;
}
.popup-header{font-size:26px;font-weight:bold;margin-bottom:14px;}
.popup-content{font-size:22px;margin-bottom:24px;}
.popup-button,.popup-close{
  background:#42a5f5;border:none;color:#fff;padding:16px 28px;font-size:22px;
  border-radius:32px;cursor:pointer;margin:8px 0;
  -webkit-appearance: none;
}
.popup-close{
  position:absolute;top:10px;right:14px;background:none;color:#999;font-size:26px;
  padding: 0px 12px;
}

/* iPad調整 */
@media (min-width: 768px) {
  .popup {
    padding-top: 40px;
  }
  .popup-button {
    padding: 20px 30px;
    font-size: 24px;
  }
}

.hidden{display:none!important;}

/* 処理中のインジケータ */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(255, 255, 255, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2000;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s, visibility 0.3s;
}
.loading-overlay.active {
  opacity: 1;
  visibility: visible;
}
.loading-spinner {
  width: 50px;
  height: 50px;
  border: 5px solid #f3f3f3;
  border-top: 5px solid #3498db;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ステータスメッセージ */
.loading-status {
  margin-top: 20px;
  color: #333;
  font-weight: 500;
  font-size: 18px;
  text-align: center;
}

  </style>
</head>
<body>
  <header>
    <h2>QRコードを読み込んでください</h2>
  </header>

  <main>
  <!-- ① QR プレビュー領域 -->
  <video id="reader" playsinline muted></video>
  <div id="result" style="margin-top:8px;color:#089;">読み取り待機中…</div>

  <!-- ② カメラ開始ボタン & 画像フォールバック -->
  <button id="startCameraBtn" class="btn">カメラを起動</button>
  <input id="fileInput"
         type="file"
         accept="image/*"
         capture="environment"
         class="hidden">

    <div id="formArea" class="hidden">
      <div class="field">
        <span class="label">読み取った品目コード：</span>
        <span id="codeDisplay" class="value"></span>
      </div>

      <!-- 用途選択 -->
      <p class="label">用途選択</p>
      <div id="modeSelect">
        <button class="btn mode-btn" id="modeOutpatient">外来用</button>
        <button class="btn mode-btn" id="modeVisit">訪問用</button>
      </div>

      <div class="field">
        <span class="label">品目名：</span>
        <span id="itemNameDisplay" class="value"></span>
      </div>

      <div class="field">
        <span class="label">在庫数：</span>
        <span id="stockDisplay" class="value"></span>
      </div>

      <p class="label">スタッフ名</p>
      <select id="staffSelect">
        <option value="">--選択してください--</option>
        <option value="渡会">渡会</option>
        <option value="山崎">山崎</option>
        <option value="中野">中野</option>
        <option value="桶川">桶川</option>
        <option value="加藤">加藤</option>
        <option value="鈴木">鈴木</option>
        <option value="星野">星野</option>
        <option value="池上">池上</option>
        <option value="泉水">泉水</option>
        <option value="上岡">上岡</option>
        <option value="吉田">吉田</option>
        <option value="堀井">堀井</option>
        <option value="高原">高原</option>
        <option value="村岡">村岡</option>
      </select>

      <!-- 数量 -->
      <label for="quantityInput" class="label">数量</label>
      <input
        id="quantityInput"
        type="number"
        inputmode="numeric"  
        min="1"              
        step="1"              
        placeholder="数量を入力"
        required             
        onwheel="return false;" 
      />


      <p class="label">操作種別</p>
      <button class="btn" id="inStockBtn">入庫</button>
      <button class="btn" id="outStockBtn">出庫</button>
      <button class="btn" id="returnBtn">カメラ画面へ戻る</button>
    </div>

    <!-- ポップアップ -->
    <div class="popup-overlay" id="popupOverlay">
      <div class="popup">
        <button class="popup-close" id="closePopupBtn">&times;</button>
        <div class="popup-header" id="popupHeader"></div>
        <div class="popup-content" id="popupContent"></div>
        <button class="popup-button" id="popupOkButton">OK</button>
        <button class="popup-button" id="restartButton" style="display:none;">QR読み取り画面に戻る</button>
      </div>
    </div>
    
    <!-- 処理中インジケータ -->
    <div class="loading-overlay" id="loadingOverlay">
      <div>
        <div class="loading-spinner"></div>
        <div class="loading-status" id="loadingStatus">処理中...</div>
      </div>
    </div>
  </main>

<!-- ZXing ライブラリ -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.18.6/umd/index.min.js"></script>

<!-- メインスクリプト -->
<script>
  /* ========== Apps Script のデプロイ URL ========== */
  const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbyVJxEbB-IqzJkU1Hh3C1O_QZwkAIVGa1PI98YGdEAbqcldG6G_k_kb8w5KjOZfrjuODQ/exec';

/* ========== 確実なSafari対応 callApi 関数 ========== */
function callApi(method, action, data, callback) {
  console.log('=== callApi呼び出し ===');
  console.log('Method:', method);
  console.log('Action:', action);
  console.log('Data:', data);
  
  const timestamp = Date.now();
  const random = Math.floor(Math.random() * 10000);
  const callbackName = 'gas_cb_' + timestamp + '_' + random;
  
  // URLを構築
  let url = API_BASE_URL + '?';
  const params = [];
  
  // callbackを最初に追加
  params.push('callback=' + encodeURIComponent(callbackName));
  params.push('action=' + encodeURIComponent(action));
  
  if (data) {
    Object.keys(data).forEach(key => {
      if (key !== 'action') {
        params.push(encodeURIComponent(key) + '=' + encodeURIComponent(data[key]));
      }
    });
  }
  
  // タイムスタンプを追加（キャッシュ防止）
  params.push('_=' + timestamp);
  
  url += params.join('&');
  
  let isResolved = false;
  let timeoutId;
  
  // グローバルコールバック関数
  window[callbackName] = function(result) {
    if (isResolved) return;
    isResolved = true;
    
    console.log('JSONP success:', callbackName, result);
    clearTimeout(timeoutId);
    cleanup();
    callback(null, result);
  };
  
  // クリーンアップ関数
  function cleanup() {
    try {
      const script = document.getElementById(callbackName);
      if (script && script.parentNode) {
        script.parentNode.removeChild(script);
      }
    } catch (e) {
      console.warn('Script cleanup failed:', e);
    }
    
    try {
      delete window[callbackName];
    } catch (e) {
      window[callbackName] = undefined;
    }
  }
  
  // タイムアウト設定
  timeoutId = setTimeout(() => {
    if (isResolved) return;
    isResolved = true;
    
    console.error('JSONP timeout:', callbackName);
    cleanup();
    callback(new Error('Request timeout after 30 seconds'), null);
  }, 30000);
  
  // スクリプト要素作成
  const script = document.createElement('script');
  script.id = callbackName;
  script.type = 'text/javascript';
  script.async = true;
  script.charset = 'utf-8';
  
  script.onerror = function(event) {
    if (isResolved) return;
    isResolved = true;
    
    console.error('JSONP script error:', event);
    clearTimeout(timeoutId);
    cleanup();
    callback(new Error('Script loading failed'), null);
  };
  
  console.log('JSONP request URL:', url);
  script.src = url;
  
  // DOM に追加
  document.head.appendChild(script);
}

  /* --- ZXing を取得 --- */
  const BrowserQRCodeReader = ZXing.BrowserQRCodeReader;
  const NotFoundException   = ZXing.NotFoundException;

  /* ---------- グローバル状
